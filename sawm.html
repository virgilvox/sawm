<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>sawm — fasting companion</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;1,300&display=swap');

  :root {
    --bg: #0a0a0a;
    --surface: #111111;
    --surface-2: #1a1a1a;
    --surface-3: #222222;
    --border: #2a2a2a;
    --text: #e8e0d4;
    --text-dim: #7a7268;
    --text-mid: #a89e92;
    --amber: #d4a043;
    --amber-dim: #8a6a2e;
    --amber-glow: rgba(212, 160, 67, 0.15);
    --green: #5a9a6a;
    --green-dim: rgba(90, 154, 106, 0.2);
    --blue: #5a8aaa;
    --red: #c45a4a;
    --mono: 'JetBrains Mono', monospace;
    --serif: 'Source Serif 4', Georgia, serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    font-size: 14px;
    line-height: 1.6;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  body {
    max-width: 480px;
    margin: 0 auto;
    padding: 0 16px;
    padding-bottom: 100px;
  }

  /* HEADER */
  .header {
    padding: 24px 0 16px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
  }
  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
  }
  .logo {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: lowercase;
    color: var(--amber);
  }
  .logo span { color: var(--text-dim); font-weight: 300; }
  .header-meta {
    font-size: 11px;
    color: var(--text-dim);
    text-align: right;
    line-height: 1.4;
  }
  .ramadan-day {
    font-size: 12px;
    color: var(--amber);
    margin-top: 8px;
    font-weight: 500;
  }

  /* LOCATION BAR */
  .location-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 20px;
    font-size: 12px;
    color: var(--text-dim);
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .location-bar:hover { border-color: var(--amber-dim); }
  .location-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--green);
    flex-shrink: 0;
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
  .location-dot.error { background: var(--red); animation: none; }
  .location-text { flex: 1; }

  /* STATUS LABEL */
  .status-label {
    text-align: center;
    padding: 12px;
    margin-bottom: 20px;
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    border-radius: 4px;
  }
  .status-label.fasting {
    background: var(--amber-glow);
    color: var(--amber);
    border: 1px solid var(--amber-dim);
  }
  .status-label.eating {
    background: var(--green-dim);
    color: var(--green);
    border: 1px solid rgba(90, 154, 106, 0.3);
  }
  .status-label.waiting {
    background: var(--surface);
    color: var(--text-dim);
    border: 1px solid var(--border);
  }

  /* PROGRESS RING */
  .ring-container {
    position: relative;
    width: 260px;
    height: 260px;
    margin: 0 auto 24px;
  }
  .ring-svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
  }
  .ring-bg {
    fill: none;
    stroke: var(--surface-2);
    stroke-width: 8;
  }
  .ring-progress {
    fill: none;
    stroke: var(--amber);
    stroke-width: 8;
    stroke-linecap: round;
    transition: stroke-dashoffset 1s ease;
    filter: drop-shadow(0 0 6px rgba(212, 160, 67, 0.3));
  }
  .ring-center {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }
  .ring-time {
    font-size: 36px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: 0.02em;
    line-height: 1;
  }
  .ring-label {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .ring-sub {
    font-size: 13px;
    color: var(--amber);
    margin-top: 8px;
    font-weight: 400;
  }

  /* TIME MARKERS */
  .time-markers {
    display: flex;
    justify-content: space-between;
    padding: 0 8px;
    margin-bottom: 24px;
  }
  .time-marker {
    text-align: center;
    font-size: 11px;
  }
  .time-marker-label {
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 2px;
  }
  .time-marker-value {
    color: var(--text-mid);
    font-weight: 500;
  }
  .time-marker-value .term {
    cursor: help;
    border-bottom: 1px dotted var(--text-dim);
  }

  /* SECTIONS */
  .section {
    margin-bottom: 20px;
  }
  .section-header {
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    margin-bottom: 10px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }

  /* HYDRATION TRACKER */
  .hydration {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px;
  }
  .hydration-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 12px;
  }
  .hydration-count {
    font-size: 28px;
    font-weight: 700;
    color: var(--blue);
  }
  .hydration-count span {
    font-size: 14px;
    font-weight: 300;
    color: var(--text-dim);
  }
  .hydration-goal {
    font-size: 11px;
    color: var(--text-dim);
  }
  .hydration-bar-track {
    height: 4px;
    background: var(--surface-3);
    border-radius: 2px;
    margin-bottom: 12px;
    overflow: hidden;
  }
  .hydration-bar-fill {
    height: 100%;
    background: var(--blue);
    border-radius: 2px;
    transition: width 0.3s ease;
  }
  .hydration-cups {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }
  .hydration-cup {
    width: 32px; height: 32px;
    border: 1px solid var(--border);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.15s;
    background: var(--surface-2);
    user-select: none;
  }
  .hydration-cup.filled {
    background: rgba(90, 138, 170, 0.15);
    border-color: var(--blue);
  }
  .hydration-cup:active { transform: scale(0.92); }
  .hydration-actions {
    display: flex;
    gap: 8px;
  }
  .hydration-btn {
    flex: 1;
    padding: 8px;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-mid);
    font-family: var(--mono);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .hydration-btn:hover {
    border-color: var(--blue);
    color: var(--text);
  }
  .hydration-btn.primary {
    background: rgba(90, 138, 170, 0.1);
    border-color: rgba(90, 138, 170, 0.3);
    color: var(--blue);
  }
  .hydration-disabled {
    text-align: center;
    padding: 16px;
    color: var(--text-dim);
    font-size: 12px;
    font-style: italic;
    font-family: var(--serif);
  }

  /* GUIDANCE CARD */
  .guidance {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 16px;
    border-left: 3px solid var(--amber-dim);
  }
  .guidance-phase {
    font-size: 11px;
    color: var(--amber);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 8px;
  }
  .guidance-text {
    font-family: var(--serif);
    font-size: 14px;
    color: var(--text);
    line-height: 1.7;
  }
  .guidance-text p { margin-bottom: 8px; }
  .guidance-text p:last-child { margin-bottom: 0; }

  /* SCHEDULE */
  .schedule {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .schedule-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 12px;
  }
  .schedule-item.active {
    border-color: var(--amber-dim);
    background: var(--amber-glow);
  }
  .schedule-name {
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 2px;
  }
  .schedule-time {
    font-size: 16px;
    font-weight: 500;
    color: var(--text);
  }
  .schedule-item.active .schedule-time { color: var(--amber); }

  /* GLOSSARY */
  .glossary-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    color: var(--text-dim);
    transition: all 0.2s;
    margin-bottom: 8px;
  }
  .glossary-toggle:hover { border-color: var(--amber-dim); color: var(--text-mid); }
  .glossary-toggle .arrow {
    margin-left: auto;
    transition: transform 0.2s;
    font-size: 10px;
  }
  .glossary-toggle.open .arrow { transform: rotate(90deg); }
  .glossary-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  .glossary-content.open { max-height: 600px; }
  .glossary-list {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 12px 16px;
  }
  .glossary-entry {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
  }
  .glossary-entry:last-child { border-bottom: none; }
  .glossary-term {
    color: var(--amber);
    font-weight: 500;
  }
  .glossary-def {
    color: var(--text-mid);
    font-family: var(--serif);
    margin-top: 2px;
  }

  /* TOOLTIP */
  .term {
    cursor: help;
    border-bottom: 1px dotted var(--amber-dim);
    position: relative;
    color: inherit;
  }
  .tooltip {
    display: none;
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface-3);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 6px 10px;
    font-size: 11px;
    font-family: var(--serif);
    color: var(--text-mid);
    white-space: nowrap;
    z-index: 100;
    pointer-events: none;
  }
  .term:hover .tooltip,
  .term:focus .tooltip {
    display: block;
  }

  /* LOADING */
  .loading {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-dim);
  }
  .loading-spinner {
    width: 24px; height: 24px;
    border: 2px solid var(--border);
    border-top-color: var(--amber);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* FOOTER */
  .footer {
    margin-top: 32px;
    padding: 16px 0;
    border-top: 1px solid var(--border);
    text-align: center;
    font-size: 11px;
    color: var(--text-dim);
    line-height: 1.8;
  }
  .footer a {
    color: var(--amber-dim);
    text-decoration: none;
  }

  /* FADE IN */
  .fade-in {
    opacity: 0;
    transform: translateY(8px);
    animation: fadeIn 0.4s ease forwards;
  }
  @keyframes fadeIn {
    to { opacity: 1; transform: translateY(0); }
  }
  .fade-in:nth-child(2) { animation-delay: 0.05s; }
  .fade-in:nth-child(3) { animation-delay: 0.1s; }
  .fade-in:nth-child(4) { animation-delay: 0.15s; }
  .fade-in:nth-child(5) { animation-delay: 0.2s; }
  .fade-in:nth-child(6) { animation-delay: 0.25s; }
  .fade-in:nth-child(7) { animation-delay: 0.3s; }
  .fade-in:nth-child(8) { animation-delay: 0.35s; }

  /* SETTINGS MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 24px;
    max-width: 380px;
    width: 100%;
  }
  .modal h3 {
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 16px;
    color: var(--text);
  }
  .modal label {
    display: block;
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 4px;
  }
  .modal select, .modal input {
    width: 100%;
    padding: 8px 10px;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    margin-bottom: 12px;
    outline: none;
  }
  .modal select:focus, .modal input:focus {
    border-color: var(--amber-dim);
  }
  .modal-btns {
    display: flex;
    gap: 8px;
    margin-top: 8px;
  }
  .modal-btns button {
    flex: 1;
    padding: 10px;
    border-radius: 4px;
    font-family: var(--mono);
    font-size: 12px;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--text-mid);
    transition: all 0.15s;
  }
  .modal-btns button.save {
    background: var(--amber-glow);
    border-color: var(--amber-dim);
    color: var(--amber);
  }
  .modal-btns button:hover { border-color: var(--amber); }

  /* NOT RAMADAN NOTICE */
  .not-ramadan {
    text-align: center;
    padding: 24px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 20px;
  }
  .not-ramadan p {
    font-family: var(--serif);
    color: var(--text-mid);
    font-size: 14px;
    line-height: 1.7;
  }
</style>
</head>
<body>

<div id="app">
  <div class="loading">
    <div class="loading-spinner"></div>
    <div>finding your location...</div>
  </div>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h3>settings</h3>
    <label for="calcMethod">calculation method</label>
    <select id="calcMethod">
      <option value="2">Islamic Society of North America (ISNA)</option>
      <option value="3">Muslim World League</option>
      <option value="4">Umm al-Qura, Makkah</option>
      <option value="5">Egyptian General Authority</option>
      <option value="1">University of Islamic Sciences, Karachi</option>
      <option value="0">Jafari / Shia Ithna-Ashari</option>
      <option value="7">Institute of Geophysics, Tehran</option>
      <option value="8">Gulf Region</option>
      <option value="9">Kuwait</option>
      <option value="10">Qatar</option>
      <option value="11">Majlis Ugama Islam Singapura</option>
      <option value="12">UOIF (France)</option>
      <option value="13">DIANET (Turkey)</option>
      <option value="14">Spiritual Admin of Russia</option>
      <option value="15">Moonsighting Committee Worldwide</option>
    </select>
    <label for="hydrationGoal">hydration goal (cups)</label>
    <input type="number" id="hydrationGoal" min="4" max="16" value="8">
    <div class="modal-btns">
      <button onclick="closeSettings()">cancel</button>
      <button class="save" onclick="saveSettings()">save</button>
    </div>
  </div>
</div>

<script>
// =================== STATE ===================
const STATE = {
  lat: null,
  lng: null,
  locationName: '',
  timings: null,
  method: parseInt(localStorage.getItem('sawm_method') || '2'),
  hydration: parseInt(localStorage.getItem('sawm_hydration_count') || '0'),
  hydrationGoal: parseInt(localStorage.getItem('sawm_hydration_goal') || '8'),
  hydrationDate: localStorage.getItem('sawm_hydration_date') || '',
  ramadanDay: null,
  isRamadan: false,
};

// =================== GLOSSARY DATA ===================
const GLOSSARY = {
  'Fajr': 'the pre-dawn prayer. marks the start of the daily fast.',
  'Suhoor': 'the pre-dawn meal eaten before fajr. your fuel for the day.',
  'Dhuhr': 'the midday prayer, when the sun passes its zenith.',
  'Asr': 'the afternoon prayer, in the later part of the day.',
  'Maghrib': 'the sunset prayer. marks the end of the daily fast.',
  'Iftar': 'the meal to break your fast at sunset. traditionally dates and water first.',
  'Isha': 'the night prayer, after twilight has disappeared.',
  'Taraweeh': 'extra night prayers performed during ramadan after isha.',
  'Ramadan': 'the 9th month of the islamic calendar. a month of fasting, reflection, and community.',
  'Sawm': 'fasting. one of the five pillars of islam.',
  'Qibla': 'the direction of the kaaba in mecca, faced during prayer.',
  'Duas': 'personal prayers or supplications to god.',
  'Zakat': 'obligatory charity, one of the five pillars.',
  'Laylatul Qadr': 'the night of power, believed to be in the last 10 nights of ramadan.',
};

// =================== HELPERS ===================
function timeToMinutes(timeStr) {
  if (!timeStr) return 0;
  const clean = timeStr.replace(/ \(.*\)/, '');
  const [h, m] = clean.split(':').map(Number);
  return h * 60 + m;
}

function minutesToTime(mins) {
  const h = Math.floor(mins / 60) % 24;
  const m = Math.floor(mins % 60);
  const ampm = h >= 12 ? 'pm' : 'am';
  const h12 = h % 12 || 12;
  return `${h12}:${String(m).padStart(2, '0')} ${ampm}`;
}

function formatCountdown(totalMins) {
  if (totalMins <= 0) return '0:00';
  const h = Math.floor(totalMins / 60);
  const m = Math.floor(totalMins % 60);
  if (h > 0) return `${h}h ${String(m).padStart(2,'0')}m`;
  return `${m}m`;
}

function nowMinutes() {
  const now = new Date();
  return now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60;
}

function todayStr() {
  return new Date().toISOString().slice(0, 10);
}

function termWrap(word) {
  const def = GLOSSARY[word];
  if (!def) return word;
  return `<span class="term" tabindex="0">${word}<span class="tooltip">${def}</span></span>`;
}

// =================== RAMADAN DETECTION ===================
// Ramadan 2026: Feb 18 - Mar 19 (approximately, based on moon sighting confirmed Feb 17 evening)
function getRamadanInfo() {
  const now = new Date();
  const y = now.getFullYear();

  // Known Ramadan 2026 dates (confirmed by Saudi moon sighting)
  const ramadanStart = new Date(2026, 1, 18); // Feb 18
  const ramadanEnd = new Date(2026, 2, 20);   // Mar 20 (Eid expected Mar 20)

  if (now >= ramadanStart && now < ramadanEnd) {
    const diffMs = now - ramadanStart;
    const day = Math.floor(diffMs / (1000 * 60 * 60 * 24)) + 1;
    return { isRamadan: true, day: Math.min(day, 30), totalDays: 30 };
  }

  // Check if ramadan is upcoming
  if (now < ramadanStart) {
    const daysUntil = Math.ceil((ramadanStart - now) / (1000*60*60*24));
    return { isRamadan: false, daysUntil, upcoming: true };
  }

  return { isRamadan: false, upcoming: false };
}

// =================== API ===================
async function fetchPrayerTimes(lat, lng, method) {
  const today = todayStr();
  const [y, m, d] = today.split('-');
  const url = `https://api.aladhan.com/v1/timings/${d}-${m}-${y}?latitude=${lat}&longitude=${lng}&method=${method}`;
  const res = await fetch(url);
  const data = await res.json();
  return data.data;
}

async function reverseGeocode(lat, lng) {
  try {
    const res = await fetch(`https://api.aladhan.com/v1/qibla/${lat}/${lng}`);
    return null; // aladhan doesn't do reverse geocoding, we'll use a simpler approach
  } catch(e) { return null; }
}

// =================== GUIDANCE ENGINE ===================
function getGuidance(nowMins, fajrMins, maghribMins, ishaMins) {
  const suhoorWindow = fajrMins - 60; // 1 hour before fajr
  const midFast = fajrMins + (maghribMins - fajrMins) / 2;
  const preIftar = maghribMins - 45;

  if (nowMins < suhoorWindow) {
    return {
      phase: 'night',
      title: 'rest window',
      text: `<p>prioritize sleep and hydration right now. if you haven't had ${termWrap('Suhoor')} yet, aim for complex carbs, protein, and plenty of water. oats, eggs, dates, and avocado are your best friends.</p>
<p>drink water steadily — don't chug it all at once. your body absorbs it better in sips over time.</p>`
    };
  }

  if (nowMins >= suhoorWindow && nowMins < fajrMins) {
    return {
      phase: 'suhoor',
      title: 'suhoor time',
      text: `<p>eat now if you haven't. focus on slow-burning fuel: whole grains, eggs, bananas, nut butter, yogurt. avoid salty or fried food — it'll make you thirstier.</p>
<p>drink water with intention. 2-3 glasses now. you've got ${formatCountdown(fajrMins - nowMins)} until ${termWrap('Fajr')}.</p>`
    };
  }

  if (nowMins >= fajrMins && nowMins < fajrMins + 120) {
    return {
      phase: 'early fast',
      title: 'beginning of fast',
      text: `<p>your fast has begun. the first few hours are usually the easiest — your body is still running on ${termWrap('Suhoor')} fuel.</p>
<p>good time for prayer, reading, or quiet focus work. your mind is often clearest in these hours.</p>`
    };
  }

  if (nowMins >= fajrMins + 120 && nowMins < midFast) {
    return {
      phase: 'mid-morning',
      title: 'holding steady',
      text: `<p>energy may start to dip. this is normal. avoid intense physical activity if you can. take it easy at work — your body is adjusting.</p>
<p>if you feel a headache coming on, it's likely caffeine withdrawal or mild dehydration from yesterday. it gets easier each day. sit somewhere cool if you can.</p>`
    };
  }

  if (nowMins >= midFast && nowMins < preIftar) {
    return {
      phase: 'deep fast',
      title: 'the middle stretch',
      text: `<p>this is often the hardest part. you're past the halfway mark. ${formatCountdown(maghribMins - nowMins)} to go until ${termWrap('Iftar')}.</p>
<p>if you're struggling: slow down, breathe, and know this is temporary. rest if you can. avoid cooking smells if they make it harder. some people find this is when the spiritual clarity kicks in.</p>`
    };
  }

  if (nowMins >= preIftar && nowMins < maghribMins) {
    return {
      phase: 'pre-iftar',
      title: 'almost there',
      text: `<p>you're in the home stretch. ${formatCountdown(maghribMins - nowMins)} until ${termWrap('Maghrib')}. if you're preparing food, keep it simple tonight — soup, dates, water, and a light main.</p>
<p>when you break fast: start with dates and water. eat slowly. your stomach has been empty — sudden large meals can cause pain and bloating. gentle is the way.</p>`
    };
  }

  if (nowMins >= maghribMins && nowMins < maghribMins + 60) {
    return {
      phase: 'iftar',
      title: 'iftar — break your fast',
      text: `<p>you made it through another day. start with water and dates, then a light soup or salad. wait 15-20 minutes before your main meal — your stomach needs time to wake up.</p>
<p>hydrate steadily from now until ${termWrap('Suhoor')}. track your cups below. the hydration window is open.</p>`
    };
  }

  if (nowMins >= maghribMins + 60 && nowMins < ishaMins + 90) {
    return {
      phase: 'evening',
      title: 'evening window',
      text: `<p>this is your refuel time. eat balanced meals, keep drinking water, and take it easy. many people attend ${termWrap('Taraweeh')} prayers in the evening — these are optional but meaningful.</p>
<p>try to get a snack with protein and fiber in before bed so tomorrow's fast starts easier.</p>`
    };
  }

  return {
    phase: 'late night',
    title: 'night hours',
    text: `<p>rest when you can. set an alarm for ${termWrap('Suhoor')} if you need to — don't skip it. even a few dates, yogurt, and water makes a difference.</p>
<p>keep sipping water before bed. your body will thank you tomorrow.</p>`
  };
}

// =================== FAST PHASE ===================
function getFastPhase(nowMins, fajrMins, maghribMins) {
  if (nowMins >= fajrMins && nowMins < maghribMins) {
    return 'fasting';
  }
  return 'eating';
}

// =================== RENDER ===================
function render() {
  const app = document.getElementById('app');
  const now = nowMinutes();
  const t = STATE.timings;

  if (!t) {
    app.innerHTML = `<div class="loading"><div class="loading-spinner"></div><div>loading prayer times...</div></div>`;
    return;
  }

  const fajr = timeToMinutes(t.Fajr);
  const sunrise = timeToMinutes(t.Sunrise);
  const dhuhr = timeToMinutes(t.Dhuhr);
  const asr = timeToMinutes(t.Asr);
  const maghrib = timeToMinutes(t.Maghrib);
  const isha = timeToMinutes(t.Isha);

  const phase = getFastPhase(now, fajr, maghrib);
  const ramInfo = getRamadanInfo();
  const guidance = getGuidance(now, fajr, maghrib, isha);

  // Progress calculation
  let progress = 0;
  let ringTime = '';
  let ringLabel = '';
  let ringSub = '';

  if (phase === 'fasting') {
    const totalFast = maghrib - fajr;
    const elapsed = now - fajr;
    progress = Math.min(Math.max(elapsed / totalFast, 0), 1);
    const remaining = maghrib - now;
    ringTime = formatCountdown(remaining);
    ringLabel = 'remaining';
    ringSub = `${Math.round(progress * 100)}% complete`;
  } else {
    // Eating window: track time until next fajr
    let nextFajr = fajr;
    if (now > fajr) nextFajr = fajr + 1440; // tomorrow
    const eatingTotal = now < fajr ? (fajr - maghrib + 1440) : (nextFajr - maghrib);
    const eatingElapsed = now >= maghrib ? (now - maghrib) : (now + 1440 - maghrib);
    progress = Math.min(Math.max(eatingElapsed / eatingTotal, 0), 1);
    const untilFajr = now < fajr ? (fajr - now) : (nextFajr - now);
    ringTime = formatCountdown(untilFajr);
    ringLabel = 'until fajr';
    ringSub = 'eating window';
  }

  // Ring SVG
  const radius = 110;
  const circumference = 2 * Math.PI * radius;
  const offset = circumference * (1 - progress);
  const ringColor = phase === 'fasting' ? 'var(--amber)' : 'var(--green)';

  // Hydration
  const todayKey = todayStr();
  if (STATE.hydrationDate !== todayKey) {
    STATE.hydration = 0;
    STATE.hydrationDate = todayKey;
    localStorage.setItem('sawm_hydration_date', todayKey);
    localStorage.setItem('sawm_hydration_count', '0');
  }

  const hydrationEnabled = phase === 'eating';

  // Ramadan day label
  let dayLabel = '';
  if (ramInfo.isRamadan) {
    dayLabel = `ramadan day ${ramInfo.day} of 30`;
  } else if (ramInfo.upcoming) {
    dayLabel = `${ramInfo.daysUntil} days until ramadan`;
  } else {
    dayLabel = 'ramadan has ended';
  }

  // Schedule items
  const prayers = [
    { name: 'Fajr', time: fajr },
    { name: 'Sunrise', time: sunrise },
    { name: 'Dhuhr', time: dhuhr },
    { name: 'Asr', time: asr },
    { name: 'Maghrib', time: maghrib },
    { name: 'Isha', time: isha },
  ];

  // Find current/next prayer
  let currentPrayer = prayers[prayers.length - 1].name;
  for (let i = 0; i < prayers.length; i++) {
    if (now < prayers[i].time) {
      currentPrayer = prayers[i].name;
      break;
    }
  }

  app.innerHTML = `
    <div class="header fade-in">
      <div class="header-top">
        <div class="logo">sawm <span>/ companion</span></div>
        <div class="header-meta">
          ${new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
        </div>
      </div>
      <div class="ramadan-day">${dayLabel}</div>
    </div>

    <div class="location-bar fade-in" onclick="openSettings()">
      <div class="location-dot${STATE.locationName ? '' : ' error'}"></div>
      <div class="location-text">${STATE.locationName || 'locating...'}</div>
      <span style="font-size:10px; color:var(--text-dim)">&#9881;</span>
    </div>

    <div class="status-label ${phase} fade-in">
      ${phase === 'fasting' ? '&#9790; fasting in progress' : '&#9737; eating window open'}
    </div>

    <div class="ring-container fade-in">
      <svg class="ring-svg" viewBox="0 0 260 260">
        <circle class="ring-bg" cx="130" cy="130" r="${radius}"/>
        <circle class="ring-progress" cx="130" cy="130" r="${radius}"
          stroke="${ringColor}"
          stroke-dasharray="${circumference}"
          stroke-dashoffset="${offset}"/>
      </svg>
      <div class="ring-center">
        <div class="ring-time">${ringTime}</div>
        <div class="ring-label">${ringLabel}</div>
        <div class="ring-sub">${ringSub}</div>
      </div>
    </div>

    <div class="time-markers fade-in">
      <div class="time-marker">
        <div class="time-marker-label">${termWrap('Fajr')}</div>
        <div class="time-marker-value">${minutesToTime(fajr)}</div>
      </div>
      <div class="time-marker">
        <div class="time-marker-label">${termWrap('Maghrib')}</div>
        <div class="time-marker-value">${minutesToTime(maghrib)}</div>
      </div>
      <div class="time-marker">
        <div class="time-marker-label">${termWrap('Isha')}</div>
        <div class="time-marker-value">${minutesToTime(isha)}</div>
      </div>
    </div>

    <div class="section fade-in">
      <div class="section-header">right now</div>
      <div class="guidance">
        <div class="guidance-phase">${guidance.title}</div>
        <div class="guidance-text">${guidance.text}</div>
      </div>
    </div>

    <div class="section fade-in">
      <div class="section-header">hydration tracker ${hydrationEnabled ? '' : '(opens at iftar)'}</div>
      <div class="hydration">
        ${hydrationEnabled ? `
          <div class="hydration-header">
            <div class="hydration-count">${STATE.hydration} <span>/ ${STATE.hydrationGoal} cups</span></div>
            <div class="hydration-goal">${Math.round(STATE.hydration / STATE.hydrationGoal * 100)}%</div>
          </div>
          <div class="hydration-bar-track">
            <div class="hydration-bar-fill" style="width: ${Math.min(STATE.hydration / STATE.hydrationGoal * 100, 100)}%"></div>
          </div>
          <div class="hydration-cups">
            ${Array.from({length: STATE.hydrationGoal}, (_, i) =>
              `<div class="hydration-cup ${i < STATE.hydration ? 'filled' : ''}" onclick="toggleCup(${i})">
                ${i < STATE.hydration ? '&#9679;' : '&#9675;'}
              </div>`
            ).join('')}
          </div>
          <div class="hydration-actions">
            <button class="hydration-btn" onclick="adjustHydration(-1)">- 1 cup</button>
            <button class="hydration-btn primary" onclick="adjustHydration(1)">+ 1 cup</button>
          </div>
        ` : `
          <div class="hydration-disabled">
            hydration tracking activates during the eating window.<br>
            focus on your fast — water comes at ${termWrap('Maghrib')}.
          </div>
        `}
      </div>
    </div>

    <div class="section fade-in">
      <div class="section-header">today's schedule</div>
      <div class="schedule">
        ${prayers.map(p => `
          <div class="schedule-item${p.name === currentPrayer ? ' active' : ''}">
            <div class="schedule-name">${termWrap(p.name)}</div>
            <div class="schedule-time">${minutesToTime(p.time)}</div>
          </div>
        `).join('')}
      </div>
    </div>

    <div class="section fade-in">
      <div class="section-header">glossary — new to this?</div>
      <div class="glossary-toggle" onclick="toggleGlossary(this)">
        <span>tap to see terms explained in plain language</span>
        <span class="arrow">&#9654;</span>
      </div>
      <div class="glossary-content" id="glossaryContent">
        <div class="glossary-list">
          ${Object.entries(GLOSSARY).map(([term, def]) => `
            <div class="glossary-entry">
              <div class="glossary-term">${term}</div>
              <div class="glossary-def">${def}</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>

    <div class="footer fade-in">
      sawm — a fasting companion<br>
      built with care. no ads. no tracking. no corporate nonsense.<br>
      prayer times via <a href="https://aladhan.com" target="_blank">aladhan.com</a>
    </div>
  `;
}

// =================== INTERACTIONS ===================
function toggleCup(index) {
  if (index < STATE.hydration) {
    STATE.hydration = index;
  } else {
    STATE.hydration = index + 1;
  }
  localStorage.setItem('sawm_hydration_count', STATE.hydration);
  render();
}

function adjustHydration(delta) {
  STATE.hydration = Math.max(0, Math.min(STATE.hydration + delta, STATE.hydrationGoal + 4));
  localStorage.setItem('sawm_hydration_count', STATE.hydration);
  render();
}

function toggleGlossary(el) {
  el.classList.toggle('open');
  document.getElementById('glossaryContent').classList.toggle('open');
}

function openSettings() {
  document.getElementById('calcMethod').value = STATE.method;
  document.getElementById('hydrationGoal').value = STATE.hydrationGoal;
  document.getElementById('settingsModal').classList.add('open');
}

function closeSettings() {
  document.getElementById('settingsModal').classList.remove('open');
}

async function saveSettings() {
  const method = parseInt(document.getElementById('calcMethod').value);
  const goal = parseInt(document.getElementById('hydrationGoal').value);
  STATE.method = method;
  STATE.hydrationGoal = Math.max(4, Math.min(goal, 16));
  localStorage.setItem('sawm_method', method);
  localStorage.setItem('sawm_hydration_goal', STATE.hydrationGoal);
  closeSettings();

  if (STATE.lat && STATE.lng) {
    const data = await fetchPrayerTimes(STATE.lat, STATE.lng, method);
    STATE.timings = data.timings;
  }
  render();
}

// =================== INIT ===================
async function init() {
  // Get location
  try {
    const pos = await new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: false,
        timeout: 10000,
        maximumAge: 300000,
      });
    });
    STATE.lat = pos.coords.latitude;
    STATE.lng = pos.coords.longitude;
  } catch(e) {
    // Fallback: Mesa, AZ (Moheeb's location)
    STATE.lat = 33.4152;
    STATE.lng = -111.8315;
  }

  // Fetch prayer times
  try {
    const data = await fetchPrayerTimes(STATE.lat, STATE.lng, STATE.method);
    STATE.timings = data.timings;

    // Try to get location name from the meta
    if (data.meta && data.meta.timezone) {
      const tz = data.meta.timezone;
      const city = tz.split('/').pop().replace(/_/g, ' ');
      const method = data.meta.method ? data.meta.method.name : '';
      STATE.locationName = `${city} — ${method}`;
    } else {
      STATE.locationName = `${STATE.lat.toFixed(2)}, ${STATE.lng.toFixed(2)}`;
    }
  } catch(e) {
    STATE.locationName = 'could not load prayer times';
  }

  render();

  // Update every 30 seconds
  setInterval(render, 30000);
}

init();
</script>

</body>
</html>
